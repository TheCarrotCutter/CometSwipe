<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Platformer Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
</head>
<body>
    <script>
        // Phaser game configuration
        const config = {
            type: Phaser.AUTO,
            width: 1300,
            height: 600,
            pixelArt: true,
            physics: {
                default: 'matter',
                matter: {
                    gravity: { y: 1 },
                    debug: true
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        // Game instance
        const game = new Phaser.Game(config);

        let player1;
        let platforms;
        let cursors;
        let pixelShader;
        var playerPolygon;
        var playerGraphics;
        
        function preload() {
             var url;
                // Load the pixelation plugin
                url = 'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexpixelationpipelineplugin.min.js';
                this.load.plugin('rexpixelationpipelineplugin', url, true);
        }

        function create() {
            
            const spring_strength = 0.04;
            const player_radius = 10;
            const player_color = 0xC54BB7;
            const spring_length = 100;
            playerGraphics = this.add.graphics();
            playerGraphics.fillStyle(0xffffff, 1);
            playerGraphics.lineStyle(1000, 0xffffff, 1);
            playerGraphics.setDepth(1);


            if (this.matter) {
                console.log('Matter.js is initialized!', this.matter);
            } else {
                console.error('Matter.js failed to initialize!');
            }

            var postFxPlugin = this.plugins.get('rexpixelationpipelineplugin');
            // Apply the pixelation effect to the camera
//comment this line to deactivate the shader
            this.cameraFilter = postFxPlugin.add(this.cameras.main);
//and these
            this.cameraFilter.pixelWidth = 0.5;  //5
            this.cameraFilter.pixelHeight = 0.5;
            
            // Create a simple sky background using a rectangle
            this.add.rectangle(400, 300, 1300, 700, 0x87CEEB);  // Sky Blue

            // Create static platforms using simple rectangles

            this.matter.add.rectangle(400, 568, 200, 32, { isStatic: true });
            this.matter.add.rectangle(600, 400, 200, 32, { isStatic: true });
            this.matter.add.rectangle(50, 250, 200, 32, { isStatic: true });
            this.matter.add.rectangle(0, 600, 2000, 32, { isStatic: true });
            this.add.rectangle(400, 568, 200, 32, 0x6600ff);
            this.add.rectangle(600, 400, 200, 32, 0x6600ff);
            this.add.rectangle(50, 250, 200, 32, 0x6600ff);
            this.add.rectangle(0, 600, 2000, 32, 0x6600ff);

            //base
            player1physics = this.matter.add.circle(160, 15, player_radius);

            player2physics = this.matter.add.circle(160, 35, player_radius);

            player3physics = this.matter.add.circle(170, 25, player_radius);

            player4physics = this.matter.add.circle(180, 15, player_radius);

            player5physics = this.matter.add.circle(170, 5, player_radius);

            player6physics = this.matter.add.circle(160, -5, player_radius);

            player7physics = this.matter.add.circle(150, 5, player_radius);

            //base connections
            this.matter.add.spring(player1physics, player2physics, spring_length, spring_strength);
            this.matter.add.spring(player1physics, player3physics, spring_length, spring_strength);
            this.matter.add.spring(player1physics, player4physics, spring_length, spring_strength);
            this.matter.add.spring(player1physics, player5physics, spring_length, spring_strength);
            this.matter.add.spring(player1physics, player6physics, spring_length, spring_strength);
            this.matter.add.spring(player1physics, player7physics, spring_length, spring_strength);

            //outer connections
            this.matter.add.spring(player2physics, player3physics, spring_length, spring_strength);
            this.matter.add.spring(player3physics, player4physics, spring_length, spring_strength);
            this.matter.add.spring(player4physics, player5physics, spring_length, spring_strength);
            this.matter.add.spring(player5physics, player6physics, spring_length, spring_strength);
            this.matter.add.spring(player6physics, player7physics, spring_length, spring_strength);
            this.matter.add.spring(player7physics, player2physics, spring_length, spring_strength);

            
            // Set up basic controls
            cursors = this.input.keyboard.createCursorKeys();

            // Apply shader to the camera (all objects rendered by the camera will be affected)
            this.cameras.main.setPostPipeline(pixelShader);

            console.log("Scene created successfully!");

            this.input.keyboard.on('keydown-A', function (event) {
                player1physics.body.velocity.x = 100;
                player1physics.body.velocity.y = 100;

            });
            playerPolygon = new Phaser.Geom.Polygon(
                [new Phaser.Math.Vector2(player2physics.position.x, player2physics.position.y),
                new Phaser.Math.Vector2(player3physics.position.x, player3physics.position.y),
                new Phaser.Math.Vector2(player4physics.position.x, player4physics.position.y),
                new Phaser.Math.Vector2(player5physics.position.x, player5physics.position.y),
                new Phaser.Math.Vector2(player6physics.position.x, player6physics.position.y),
                new Phaser.Math.Vector2(player7physics.position.x, player7physics.position.y)]
            );

        }

        function update(time, delta) {

            playerPolygon.setTo([      
                new Phaser.Math.Vector2(player2physics.position.x, player2physics.position.y),
                new Phaser.Math.Vector2(player3physics.position.x, player3physics.position.y),
                new Phaser.Math.Vector2(player4physics.position.x, player4physics.position.y),
                new Phaser.Math.Vector2(player5physics.position.x, player5physics.position.y),
                new Phaser.Math.Vector2(player6physics.position.x, player6physics.position.y),
                new Phaser.Math.Vector2(player7physics.position.x, player7physics.position.y)]
            );

            playerGraphics.clear();

            playerGraphics.fillPoints(playerPolygon.points, true);

            playerGraphics.strokePoints(playerPolygon.points, true);
            
            console.log(playerPolygon)
            console.log(playerGraphics)
        }
    </script>
</body>
</html>
